name: Deploy Coze Studio

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'docker/**'
      - 'Makefile'
      - 'scripts/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥éª¤2ï¼šé…ç½®SSHè¿æ¥
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # æ­¥éª¤3ï¼šæ·»åŠ æœåŠ¡å™¨åˆ°å·²çŸ¥ä¸»æœº
      - name: Add server to known_hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # æ­¥éª¤4ï¼šéƒ¨ç½²ä»£ç åˆ°æœåŠ¡å™¨ï¼ˆä¿æŠ¤ç°æœ‰é…ç½®ï¼‰
      - name: Deploy to server
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½² Coze Studio åˆ°æœåŠ¡å™¨..."

          echo "ğŸ“¦ åŒæ­¥ä»£ç åˆ°ä¸´æ—¶ç›®å½•..."
          # åˆ›å»ºå”¯ä¸€çš„ä¸´æ—¶ç›®å½•å
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          TEMP_DIR="${{ secrets.SERVER_TARGET_DIR }}/temp_deploy_${TIMESTAMP}"

          # å…ˆåŒæ­¥åˆ°ä¸´æ—¶ç›®å½•
          rsync -avz \
            --exclude '.env*' \
            --exclude '.github' \
            --exclude 'node_modules' \
            --exclude 'common/temp' \
            --exclude 'frontend/apps/*/node_modules' \
            --exclude 'frontend/packages/*/node_modules' \
            --exclude 'backend/bin' \
            --exclude 'backend/conf/model/*.yaml' \
            --exclude '**/*.log' \
            --exclude 'docker/data' \
            --exclude 'docker/volumes' \
            ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${TEMP_DIR}

          echo "ğŸ”„ å®‰å…¨æ›´æ–°ä»£ç ï¼ˆä¿æŠ¤é…ç½®æ–‡ä»¶ï¼‰..."

      # æ­¥éª¤5ï¼šåœ¨æœåŠ¡å™¨ä¸Šå®‰å…¨æ›´æ–°ä»£ç 
      - name: Execute deployment commands
        run: |
          # ä¼ é€’æ—¶é—´æˆ³åˆ°æœåŠ¡å™¨
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "TIMESTAMP=${TIMESTAMP}" << 'EOF'
          set -e
          echo "ğŸ”§ å¼€å§‹åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²å‘½ä»¤..."

          TARGET_DIR="${{ secrets.SERVER_TARGET_DIR }}"
          CODE_DIR="${TARGET_DIR}/code"
          TEMP_DIR="${TARGET_DIR}/temp_deploy_${TIMESTAMP}"

          # æ£€æŸ¥ç›®æ ‡ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "$TARGET_DIR" ]; then
            echo "ğŸ“ åˆ›å»ºç›®æ ‡ç›®å½•: $TARGET_DIR"
            mkdir -p "$TARGET_DIR"
          fi

          # æ£€æŸ¥ Docker æ˜¯å¦è¿è¡Œ
          if ! docker info > /dev/null 2>&1; then
            echo "âŒ Docker æœªè¿è¡Œï¼Œè¯·å¯åŠ¨ Docker æœåŠ¡"
            exit 1
          fi

          # åˆ›å»ºä»£ç ç›®å½•
          mkdir -p "$CODE_DIR"

          # å¤‡ä»½ç°æœ‰é…ç½®æ–‡ä»¶
          echo "ğŸ’¾ å¤‡ä»½ç°æœ‰é…ç½®æ–‡ä»¶..."
          BACKUP_DIR="${TARGET_DIR}/config_backup_${TIMESTAMP}"
          mkdir -p "$BACKUP_DIR"

          # å¤‡ä»½æ ¹ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶
          for config_file in "$TARGET_DIR"/*.env "$TARGET_DIR"/*.yaml "$TARGET_DIR"/*.yml "$TARGET_DIR"/*.json; do
            if [ -f "$config_file" ]; then
              cp "$config_file" "$BACKUP_DIR/"
              echo "âœ… å¤‡ä»½é…ç½®æ–‡ä»¶: $(basename $config_file)"
            fi
          done

          # å¤‡ä»½ä»£ç ç›®å½•ä¸­çš„æ•°æ®ç›®å½•
          if [ -d "$CODE_DIR/docker/data" ]; then
            echo "ğŸ“‚ Docker æ•°æ®ç›®å½•å·²ä¿ç•™"
          fi

          # åœæ­¢ç°æœ‰æœåŠ¡
          echo "ğŸ›‘ åœæ­¢ç°æœ‰æœåŠ¡..."
          if [ -f "$CODE_DIR/docker/docker-compose.yml" ]; then
            cd "$CODE_DIR/docker"
            docker compose down || true
          fi

          # æ›´æ–°ä»£ç åˆ° code ç›®å½•
          echo "ğŸ”„ æ›´æ–°åº”ç”¨ä»£ç åˆ° code ç›®å½•..."
          rsync -av --delete "${TEMP_DIR}/" "${CODE_DIR}/"

          # åˆ›å»ºé…ç½®æ–‡ä»¶è½¯é“¾æ¥æˆ–å¤åˆ¶
          echo "ğŸ”— è®¾ç½®é…ç½®æ–‡ä»¶é“¾æ¥..."

          # å¤„ç† Docker .env æ–‡ä»¶
          if [ -f "$TARGET_DIR/.env" ]; then
            ln -sf "$TARGET_DIR/.env" "$CODE_DIR/docker/.env"
            echo "âœ… é“¾æ¥æ ¹ç›®å½• .env åˆ° docker/.env"
          elif [ -f "$CODE_DIR/docker/.env.example" ]; then
            cp "$CODE_DIR/docker/.env.example" "$TARGET_DIR/.env"
            ln -sf "$TARGET_DIR/.env" "$CODE_DIR/docker/.env"
            echo "âœ… åˆ›å»º .env æ–‡ä»¶å¹¶å»ºç«‹é“¾æ¥"
          fi

          # å¤„ç† AI æ¨¡å‹é…ç½®æ–‡ä»¶
          mkdir -p "$CODE_DIR/backend/conf/model"
          for model_file in "$TARGET_DIR"/*.yaml "$TARGET_DIR"/*.yml; do
            if [ -f "$model_file" ]; then
              filename=$(basename "$model_file")
              ln -sf "$model_file" "$CODE_DIR/backend/conf/model/$filename"
              echo "âœ… é“¾æ¥æ¨¡å‹é…ç½®: $filename"
            fi
          done

          # å¦‚æœæ ¹ç›®å½•æ²¡æœ‰æ¨¡å‹é…ç½®ï¼Œæç¤ºç”¨æˆ·
          model_count=$(ls -1 "$TARGET_DIR"/*.yaml "$TARGET_DIR"/*.yml 2>/dev/null | wc -l)
          if [ "$model_count" -eq 0 ]; then
            echo "âš ï¸  æœªæ‰¾åˆ°æ¨¡å‹é…ç½®æ–‡ä»¶ï¼Œè¯·åœ¨ä»¥ä¸‹ä½ç½®åˆ›å»º:"
            echo "    $TARGET_DIR/openai-gpt4o.yaml"
            echo "    $TARGET_DIR/claude-3-5-sonnet.yaml"
            echo "    $TARGET_DIR/gemini-pro.yaml"
            echo ""
            echo "ğŸ“ å‚è€ƒæ¨¡æ¿æ–‡ä»¶: $CODE_DIR/backend/conf/model/template/"
          fi

          # æ¸…ç†ä¸´æ—¶ç›®å½•
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          if [ -d "$TEMP_DIR" ]; then
            rm -rf "$TEMP_DIR"
            echo "âœ… å·²æ¸…ç†ä¸´æ—¶ç›®å½•"
          fi

          # ä¿ç•™æœ€æ–°çš„3ä¸ªå¤‡ä»½
          cd "$TARGET_DIR"
          echo "ğŸ—‚ï¸  æ¸…ç†æ—§å¤‡ä»½æ–‡ä»¶..."
          ls -dt config_backup_* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null || true

          # æ¸…ç†è¿‡è€çš„æ—¥å¿—æ–‡ä»¶ï¼ˆä¿ç•™æœ€è¿‘7å¤©ï¼‰
          find "$TARGET_DIR" -name "*.log" -type f -mtime +7 -delete 2>/dev/null || true

          # è¿”å› docker ç›®å½•å‡†å¤‡å¯åŠ¨æœåŠ¡
          cd "$CODE_DIR/docker"

          # æ‹‰å–æœ€æ–°é•œåƒå¹¶å¯åŠ¨æœåŠ¡
          echo "ğŸ³ å¯åŠ¨ Docker æœåŠ¡..."
          docker compose pull || true
          docker compose up -d

          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 30

          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
          docker compose ps

          # æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
          if docker compose ps | grep -q "unhealthy\|exited"; then
            echo "âŒ æŸäº›æœåŠ¡å¯åŠ¨å¤±è´¥"
            docker compose logs --tail=50
            exit 1
          fi

          # æ£€æŸ¥ä¸»æœåŠ¡æ˜¯å¦å¯è®¿é—®
          echo "ğŸŒ æ£€æŸ¥æœåŠ¡å¯è®¿é—®æ€§..."
          sleep 10
          if curl -f http://localhost:8888 > /dev/null 2>&1; then
            echo "âœ… Coze Studio æœåŠ¡å¯åŠ¨æˆåŠŸï¼"
            echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼è®¿é—®åœ°å€: http://${{ secrets.SERVER_HOST }}:8888"
          else
            echo "âš ï¸  æœåŠ¡å¯èƒ½ä»åœ¨å¯åŠ¨ä¸­ï¼Œè¯·ç¨åæ£€æŸ¥"
            echo "ğŸ“‹ æŸ¥çœ‹æ—¥å¿—å‘½ä»¤: docker compose logs -f"
          fi

          # æ¸…ç†æ—§çš„ Docker é•œåƒ
          echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
          docker image prune -f || true

          EOF
