// Code generated by hertz generator.

package ynet_agent

import (
	"context"
	"fmt"
	"time"

	"github.com/cloudwego/hertz/pkg/app"
	"github.com/cloudwego/hertz/pkg/protocol/consts"
	"github.com/coze-dev/coze-studio/backend/api/model/app/bot_common"
	"github.com/coze-dev/coze-studio/backend/api/model/playground"
	ynet_agent "github.com/coze-dev/coze-studio/backend/api/model/ynet_agent"
	"github.com/coze-dev/coze-studio/backend/application/singleagent"
)

// RevertDraftBot .
// @router /api/ynet-agent/revert-draft-bot [POST]
func RevertDraftBot(ctx context.Context, c *app.RequestContext) {
	var err error
	var req ynet_agent.RevertDraftBotRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	// 步骤1: 获取指定版本的智能体数据
	getReq := &playground.GetDraftBotInfoAgwRequest{
		BotID:   req.BotID,
		Version: &req.Version, // 传入版本号获取历史版本数据
	}
	
	historyData, err := singleagent.SingleAgentSVC.GetAgentBotInfo(ctx, getReq)
	if err != nil {
		resp := &ynet_agent.RevertDraftBotResponse{
			Code: 500,
			Msg:  fmt.Sprintf("Failed to get history version data: %v", err),
		}
		c.JSON(consts.StatusOK, resp)
		return
	}

	if historyData == nil || historyData.Data == nil || historyData.Data.BotInfo == nil {
		resp := &ynet_agent.RevertDraftBotResponse{
			Code: 404,
			Msg:  "History version not found",
		}
		c.JSON(consts.StatusOK, resp)
		return
	}

	// 步骤2: 将历史版本数据转换为更新请求格式
	// 需要将 BotInfo 转换为 BotInfoForUpdate
	botInfoForUpdate := convertBotInfoToForUpdate(historyData.Data.BotInfo)
	
	updateReq := &playground.UpdateDraftBotInfoAgwRequest{
		BotInfo: botInfoForUpdate,
	}
	
	// 确保更新的是当前草稿（不带版本号）
	updateReq.BotInfo.Version = nil
	
	// 添加调试信息：更新前
	fmt.Printf("[DEBUG] About to call UpdateSingleAgentDraft for bot_id=%d, version=%s\n", req.BotID, req.Version)
	var nameStr, descStr string
	if updateReq.BotInfo.Name != nil {
		nameStr = *updateReq.BotInfo.Name
	}
	if updateReq.BotInfo.Description != nil {
		descStr = *updateReq.BotInfo.Description
	}
	fmt.Printf("[DEBUG] UpdateReq BotInfo fields - Name: %s, Description: %s\n", nameStr, descStr)
	
	updateResp, err := singleagent.SingleAgentSVC.UpdateSingleAgentDraft(ctx, updateReq)
	if err != nil {
		fmt.Printf("[DEBUG] UpdateSingleAgentDraft failed with error: %v\n", err)
		resp := &ynet_agent.RevertDraftBotResponse{
			Code: 500,
			Msg:  fmt.Sprintf("Failed to update draft: %v", err),
		}
		c.JSON(consts.StatusOK, resp)
		return
	}

	// 添加调试信息：更新后
	fmt.Printf("[DEBUG] UpdateSingleAgentDraft completed with code: %d, msg: %s\n", updateResp.Code, updateResp.Msg)

	if updateResp.Code != 0 {
		resp := &ynet_agent.RevertDraftBotResponse{
			Code: int32(updateResp.Code),
			Msg:  updateResp.Msg,
		}
		c.JSON(consts.StatusOK, resp)
		return
	}

	// 步骤3: 返回成功响应
	message := fmt.Sprintf("Successfully reverted bot %d to version %s. Update response code: %d", req.BotID, req.Version, updateResp.Code)
	resp := &ynet_agent.RevertDraftBotResponse{
		Code: 0,
		Msg:  "success", 
		Data: &ynet_agent.RevertDraftBotData{
			BotID:     req.BotID,
			Version:   req.Version,
			UpdatedAt: time.Now().Unix(),
			Message:   &message,
		},
	}

	c.JSON(consts.StatusOK, resp)
}

// convertBotInfoToForUpdate 将 BotInfo 转换为 BotInfoForUpdate
// 为了确保完整回滚，我们需要设置所有字段
func convertBotInfoToForUpdate(botInfo *bot_common.BotInfo) *bot_common.BotInfoForUpdate {
	if botInfo == nil {
		return nil
	}
	
	// 复制基本字段（指针类型）
	botId := botInfo.BotId
	name := botInfo.Name
	description := botInfo.Description
	iconUri := botInfo.IconUri
	iconUrl := botInfo.IconUrl
	creatorId := botInfo.CreatorId
	createTime := botInfo.CreateTime
	updateTime := botInfo.UpdateTime
	connectorId := botInfo.ConnectorId
	version := botInfo.Version
	
	// 处理 BotMode 类型转换（int64 -> *BotMode）
	var botMode *bot_common.BotMode
	if botInfo.BotMode != 0 {
		mode := bot_common.BotMode(botInfo.BotMode)
		botMode = &mode
	}
	
	result := &bot_common.BotInfoForUpdate{
		BotId:            &botId,
		Name:             &name,
		Description:      &description,
		IconUri:          &iconUri,
		IconUrl:          &iconUrl,
		CreatorId:        &creatorId,
		CreateTime:       &createTime,
		UpdateTime:       &updateTime,
		ConnectorId:      &connectorId,
		Version:          &version,
		ModelInfo:        botInfo.ModelInfo,
		PromptInfo:       botInfo.PromptInfo,
		PluginInfoList:   botInfo.PluginInfoList,
		WorkflowInfoList: botInfo.WorkflowInfoList,
		OnboardingInfo:   botInfo.OnboardingInfo,
		Knowledge:        botInfo.Knowledge,
		VariableList:     botInfo.VariableList,
		TaskInfo:         botInfo.TaskInfo,
		DatabaseList:     botInfo.DatabaseList,
		SuggestReplyInfo: botInfo.SuggestReplyInfo,
		VoicesInfo:       botInfo.VoicesInfo,
		BotExtInfo:       botInfo.BotExtInfo,
		BotMode:          botMode,
		// 注意：暂时跳过 Agents 字段，因为类型不兼容（Agent vs AgentForUpdate）
		// Agents:           botInfo.Agents,  // 需要特殊转换
	}
	
	// 对于空的复合字段，也要明确设置，以确保完全替换
	if result.PluginInfoList == nil {
		result.PluginInfoList = []*bot_common.PluginInfo{}
	}
	if result.WorkflowInfoList == nil {
		result.WorkflowInfoList = []*bot_common.WorkflowInfo{}
	}
	if result.VariableList == nil {
		result.VariableList = []*bot_common.Variable{}
	}
	if result.DatabaseList == nil {
		result.DatabaseList = []*bot_common.Database{}
	}
	// 注意：暂时不处理 Agents 字段，因为需要复杂的类型转换
	
	return result
}
