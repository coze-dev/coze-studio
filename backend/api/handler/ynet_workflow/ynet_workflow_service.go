/*
 * Copyright 2025 coze-dev Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

// Code generated by hertz generator.

package ynet_workflow

import (
	"context"
	"fmt"
	"strconv"
	"time"

	"github.com/cloudwego/hertz/pkg/app"
	"github.com/cloudwego/hertz/pkg/protocol/consts"
	ynet_workflow "github.com/coze-dev/coze-studio/backend/api/model/ynet_workflow"
	appworkflow "github.com/coze-dev/coze-studio/backend/application/workflow"
	"github.com/coze-dev/coze-studio/backend/domain/workflow"
	"github.com/coze-dev/coze-studio/backend/domain/workflow/entity/vo"
	"github.com/coze-dev/coze-studio/backend/pkg/lang/ternary"
	"github.com/coze-dev/coze-studio/backend/pkg/logs"
)


// VersionHistoryList .
// @router /api/workflow_api/version_list [POST]
func VersionHistoryList(ctx context.Context, c *app.RequestContext) {
	var err error
	var req ynet_workflow.VersionHistoryListRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	// 解析 workflow_id
	workflowID, err := strconv.ParseInt(req.WorkflowID, 10, 64)
	if err != nil {
		c.JSON(consts.StatusOK, &ynet_workflow.VersionHistoryListResponse{
			Code: 400,
			Msg:  "Invalid workflow_id",
		})
		return
	}

	// space_id 作为冗余字段，不参与实际查询逻辑
	// 实际查询只使用 workflow_id
	if req.SpaceID != "" {
		// 验证格式但不用于查询
		if _, err := strconv.ParseInt(req.SpaceID, 10, 64); err != nil {
			c.JSON(consts.StatusOK, &ynet_workflow.VersionHistoryListResponse{
				Code: 400,
				Msg:  "Invalid space_id format",
			})
			return
		}
	}

	// 获取 workflow repository
	repo := workflow.GetRepository()
	if repo == nil {
		logs.CtxErrorf(ctx, "workflow repository not initialized")
		c.JSON(consts.StatusOK, &ynet_workflow.VersionHistoryListResponse{
			Code: 500,
			Msg:  "Internal server error",
		})
		return
	}

	versionList := make([]*ynet_workflow.VersionMetaInfo, 0)

	// 根据type参数决定查询类型
	// Type: 1 = SubmitOperate (提交/草稿), 2 = PublishOperate (发布版本)
	// 兼容旧版本: type: 4 也表示 PublishOperate, type: 3 也表示 SubmitOperate
	if req.Type == 2 || req.Type == 4 { // PublishOperate - 查询所有发布版本
		logs.CtxInfof(ctx, "Querying workflow_version table for workflow_id: %d, limit: %d", workflowID, req.Limit)

		// 使用新添加的 GetVersionList 方法获取所有版本
		versions, err := repo.GetVersionList(ctx, workflowID, int(req.Limit))
		if err != nil {
			logs.CtxErrorf(ctx, "Failed to get version list for workflow %d: %v", workflowID, err)
		} else {
			logs.CtxInfof(ctx, "Found %d versions for workflow %d", len(versions), workflowID)

			for _, version := range versions {
				// 处理用户头像URL（在repository层已经处理过了，这里直接使用）
				userAvatarURL := version.CreatorIconURI
				if userAvatarURL == "" {
					userAvatarURL = "" // 保持为空，前端可以显示默认头像
				}

				versionInfo := &ynet_workflow.VersionMetaInfo{
					CommitID:    version.CommitID,
					Version:     version.Version,
					CreatedAt:   version.VersionCreatedAt.UnixMilli(),
					CreateTime:  int64Ptr(version.VersionCreatedAt.UnixMilli()),
					CreatorName: ternary.IFElse(version.CreatorName != "", version.CreatorName, fmt.Sprintf("User_%d", version.VersionCreatorID)),
					Description: stringPtr(version.VersionDescription),
					Desc:        stringPtr(version.VersionDescription),
					Type:        intPtr(2), // PublishOperate
					Offline:     boolPtr(false),
					User: &ynet_workflow.UserInfo{
						UserName:   ternary.IFElse(version.CreatorName != "", version.CreatorName, fmt.Sprintf("User_%d", version.VersionCreatorID)),
						UserAvatar: stringPtr(userAvatarURL), // 使用预签名URL
					},
				}
				versionList = append(versionList, versionInfo)
			}
		}

		logs.CtxInfof(ctx, "Total versions returned: %d", len(versionList))
	} else if req.Type == 1 || req.Type == 3 { // SubmitOperate - 查询草稿和快照
		logs.CtxInfof(ctx, "Querying draft and snapshots for workflow_id: %d", workflowID)

		// 先获取当前草稿
		draft, err := repo.DraftV2(ctx, workflowID, "")
		if err != nil {
			logs.CtxInfof(ctx, "No current draft found for workflow %d: %v", workflowID, err)
		}
		if draft != nil {
			logs.CtxInfof(ctx, "Found current draft with commit: %s", draft.CommitID)
			updatedAt := time.Now().UnixMilli()
			if draft.DraftMeta != nil && !draft.DraftMeta.Timestamp.IsZero() {
				updatedAt = draft.DraftMeta.Timestamp.UnixMilli()
			}

			currentDraft := &ynet_workflow.VersionMetaInfo{
				CommitID:    draft.CommitID,
				Version:     "current-draft",
				CreatedAt:   updatedAt,
				CreateTime:  int64Ptr(updatedAt),
				CreatorName: "Current User",
				Description: stringPtr("当前草稿"),
				Desc:        stringPtr("当前草稿"),
				Type:        intPtr(1), // SubmitOperate
				Offline:     boolPtr(false),
				User: &ynet_workflow.UserInfo{
					UserName:   "Current User",
					UserAvatar: stringPtr(""),
				},
			}
			versionList = append(versionList, currentDraft)
		}

		// 注意：workflow_snapshot 表的查询需要在repository层添加相应方法
		// 目前只返回当前草稿
		logs.CtxInfof(ctx, "Total drafts found: %d", len(versionList))
	} else {
		// 默认返回混合类型 - 草稿和发布版本
		logs.CtxInfof(ctx, "Querying mixed types (drafts + versions) for workflow_id: %d", workflowID)

		// 先返回草稿
		draft, _ := repo.DraftV2(ctx, workflowID, "")
		if draft != nil {
			updatedAt := time.Now().UnixMilli()
			if draft.DraftMeta != nil && !draft.DraftMeta.Timestamp.IsZero() {
				updatedAt = draft.DraftMeta.Timestamp.UnixMilli()
			}

			currentDraft := &ynet_workflow.VersionMetaInfo{
				CommitID:    draft.CommitID,
				Version:     "current-draft",
				CreatedAt:   updatedAt,
				CreateTime:  int64Ptr(updatedAt),
				CreatorName: "Current User",
				Description: stringPtr("当前工作版本"),
				Desc:        stringPtr("当前工作版本"),
				Type:        intPtr(1), // SubmitOperate
				Offline:     boolPtr(false),
				User: &ynet_workflow.UserInfo{
					UserName:   "Current User",
					UserAvatar: stringPtr(""),
				},
			}
			versionList = append(versionList, currentDraft)
		}

		// 添加所有发布版本
		remainingLimit := int(req.Limit) - len(versionList)
		if remainingLimit > 0 {
			versions, err := repo.GetVersionList(ctx, workflowID, remainingLimit)
			if err != nil {
				logs.CtxErrorf(ctx, "Failed to get version list for mixed query: %v", err)
			} else {
				for _, version := range versions {
					versionInfo := &ynet_workflow.VersionMetaInfo{
						CommitID:    version.CommitID,
						Version:     version.Version,
						CreatedAt:   version.VersionCreatedAt.UnixMilli(),
						CreateTime:  int64Ptr(version.VersionCreatedAt.UnixMilli()),
						CreatorName: fmt.Sprintf("User_%d", version.VersionCreatorID),
						Description: stringPtr(version.VersionDescription),
						Desc:        stringPtr(version.VersionDescription),
						Type:        intPtr(2), // PublishOperate
						Offline:     boolPtr(false),
						User: &ynet_workflow.UserInfo{
							UserName:   fmt.Sprintf("User_%d", version.VersionCreatorID),
							UserAvatar: stringPtr(""),
						},
					}
					versionList = append(versionList, versionInfo)
				}
			}
		}

		logs.CtxInfof(ctx, "Total mixed versions found: %d", len(versionList))
	}

	// 构建响应
	resp := &ynet_workflow.VersionHistoryListResponse{
		VersionList: versionList,
		HasMore:     false,
		Cursor:      nil,
		Code:        0,
		Msg:         "success",
	}

	c.JSON(consts.StatusOK, resp)
}

// 辅助函数
func stringPtr(s string) *string {
	if s == "" {
		return nil
	}
	return &s
}

func boolPtr(b bool) *bool {
	return &b
}

func intPtr(i int32) *int32 {
	return &i
}

func int64Ptr(i int64) *int64 {
	return &i
}

// RevertDraft - 版本回滚接口
// @router /api/workflow_api/revert_draft [POST]
func RevertDraft(ctx context.Context, c *app.RequestContext) {
	var err error
	var req ynet_workflow.RevertDraftRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	// 解析 workflow_id 和 space_id
	workflowID, err := strconv.ParseInt(req.WorkflowID, 10, 64)
	if err != nil {
		c.JSON(consts.StatusOK, &ynet_workflow.RevertDraftResponse{
			Success: false,
			Message: stringPtr("Invalid workflow_id"),
			Code:    400,
			Msg:     "Invalid workflow_id",
		})
		return
	}

	// space_id 作为冗余字段，验证格式但不用于查询
	if req.SpaceID != "" {
		if _, err := strconv.ParseInt(req.SpaceID, 10, 64); err != nil {
			c.JSON(consts.StatusOK, &ynet_workflow.RevertDraftResponse{
				Success: false,
				Message: stringPtr("Invalid space_id format"),
				Code:    400,
				Msg:     "Invalid space_id format",
			})
			return
		}
	}

	// 获取 workflow repository
	repo := workflow.GetRepository()
	if repo == nil {
		logs.CtxErrorf(ctx, "workflow repository not initialized")
		c.JSON(consts.StatusOK, &ynet_workflow.RevertDraftResponse{
			Success: false,
			Message: stringPtr("Internal server error"),
			Code:    500,
			Msg:     "Internal server error",
		})
		return
	}

	// 实现版本回滚逻辑
	// 1. 根据commit_id获取历史版本的canvas数据
	// 2. 更新当前草稿为历史版本的内容

	logs.CtxInfof(ctx, "Reverting workflow %d to commit %s (space_id: %s)", workflowID, req.CommitID, req.SpaceID)

	// 获取历史版本数据
	var versionInfo *vo.VersionInfo

	if req.Type == 4 { // PublishOperate - 从发布版本回滚
		// 尝试通过版本号获取
		versionInfo, err = repo.GetVersion(ctx, workflowID, req.CommitID)
		if err != nil {
			// 如果找不到，尝试获取最新版本
			versionInfo, err = repo.GetLatestVersion(ctx, workflowID)
		}
	} else { // SubmitOperate - 从草稿快照回滚
		// 获取指定commit的草稿
		draft, err := repo.DraftV2(ctx, workflowID, req.CommitID)
		if err == nil && draft != nil {
			// 创建新的草稿基于历史快照
			newCommitID := fmt.Sprintf("revert-%s-%d", req.CommitID[:8], time.Now().Unix())
			newDraft := &vo.DraftInfo{
				Canvas:          draft.Canvas,
				InputParamsStr:  draft.InputParamsStr,
				OutputParamsStr: draft.OutputParamsStr,
				CommitID:        newCommitID,
				DraftMeta: &vo.DraftMeta{
					Timestamp: time.Now(),
					Modified:  true,
				},
			}

			// 更新草稿
			err = repo.CreateOrUpdateDraft(ctx, workflowID, newDraft)
			if err != nil {
				logs.CtxErrorf(ctx, "failed to update draft: %v", err)
				c.JSON(consts.StatusOK, &ynet_workflow.RevertDraftResponse{
					Success: false,
					Message: stringPtr("Failed to revert draft"),
					Code:    500,
					Msg:     "Failed to revert draft",
				})
				return
			}

			// 构建成功响应
			c.JSON(consts.StatusOK, &ynet_workflow.RevertDraftResponse{
				Success: true,
				Message: stringPtr(fmt.Sprintf("Successfully reverted to snapshot %s", req.CommitID)),
				Code:    0,
				Msg:     "success",
			})
			return
		}
	}

	if versionInfo != nil {
		// 基于版本信息创建新草稿
		newCommitID := fmt.Sprintf("revert-%s-%d", versionInfo.Version, time.Now().Unix())
		newDraft := &vo.DraftInfo{
			Canvas:          versionInfo.Canvas,
			InputParamsStr:  versionInfo.InputParamsStr,
			OutputParamsStr: versionInfo.OutputParamsStr,
			CommitID:        newCommitID,
			DraftMeta: &vo.DraftMeta{
				Timestamp: time.Now(),
				Modified:  true,
			},
		}

		// 更新草稿
		err = repo.CreateOrUpdateDraft(ctx, workflowID, newDraft)
		if err != nil {
			logs.CtxErrorf(ctx, "failed to update draft: %v", err)
			c.JSON(consts.StatusOK, &ynet_workflow.RevertDraftResponse{
				Success: false,
				Message: stringPtr("Failed to revert draft"),
				Code:    500,
				Msg:     "Failed to revert draft",
			})
			return
		}

		// 构建成功响应
		c.JSON(consts.StatusOK, &ynet_workflow.RevertDraftResponse{
			Success: true,
			Message: stringPtr(fmt.Sprintf("Successfully reverted to version %s", versionInfo.Version)),
			Code:    0,
			Msg:     "success",
		})
		return
	}

	// 如果找不到版本
	c.JSON(consts.StatusOK, &ynet_workflow.RevertDraftResponse{
		Success: false,
		Message: stringPtr("Version not found"),
		Code:    404,
		Msg:     "Version not found",
	})
}

// GetVersionSchema .
// @router /api/workflow_api/get_version_schema [POST]
func GetVersionSchema(ctx context.Context, c *app.RequestContext) {
	var err error
	var req ynet_workflow.GetVersionSchemaRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	// 解析 workflow_id
	workflowID, err := strconv.ParseInt(req.WorkflowID, 10, 64)
	if err != nil {
		c.JSON(consts.StatusOK, &ynet_workflow.GetVersionSchemaResponse{
			Code: 400,
			Msg:  "Invalid workflow_id",
		})
		return
	}

	// space_id 作为冗余字段，不参与实际查询逻辑
	// 实际查询只使用 workflow_id 和 commit_id
	if req.SpaceID != "" {
		// 验证格式但不用于查询
		if _, err := strconv.ParseInt(req.SpaceID, 10, 64); err != nil {
			c.JSON(consts.StatusOK, &ynet_workflow.GetVersionSchemaResponse{
				Code: 400,
				Msg:  "Invalid space_id format",
			})
			return
		}
	}

	// 获取 workflow repository
	repo := workflow.GetRepository()
	if repo == nil {
		logs.CtxErrorf(ctx, "workflow repository not initialized")
		c.JSON(consts.StatusOK, &ynet_workflow.GetVersionSchemaResponse{
			Code: 500,
			Msg:  "Internal server error",
		})
		return
	}

	logs.CtxInfof(ctx, "GetVersionSchema for workflow_id: %d, commit_id: %s, type: %d", workflowID, req.CommitID, req.Type)

	var schema, name, description, iconURL, version string
	var createdAt int64
	var inputParams, outputParams string
	var flowMode int32

	// 根据type参数和commit_id决定查询类型
	if (req.Type == 2 || req.Type == 4) && req.CommitID != "" { // PublishOperate且有具体的commit_id - 查询发布版本
		logs.CtxInfof(ctx, "Querying published version for commit_id: %s", req.CommitID)
		
		var versionInfo *vo.VersionInfo
		var err error
		
		// 直接使用commit_id查询版本（无论是数字还是字符串）
		logs.CtxInfof(ctx, "Querying version by commit_id: %s", req.CommitID)
		
		versionInfo, err = repo.GetVersionByCommitID(ctx, workflowID, req.CommitID)
		
		if err != nil {
			logs.CtxErrorf(ctx, "Failed to get version for workflow %d, commit_id %s: %v", workflowID, req.CommitID, err)
			c.JSON(consts.StatusOK, &ynet_workflow.GetVersionSchemaResponse{
				Code: 404,
				Msg:  "Version not found",
			})
			return
		}

		if versionInfo != nil {
			schema = versionInfo.Canvas
			version = versionInfo.Version
			createdAt = versionInfo.VersionCreatedAt.UnixMilli()
			inputParams = versionInfo.InputParamsStr
			outputParams = versionInfo.OutputParamsStr
			
			// 获取工作流元信息 - 从发布版本的Canvas中获取，或者查询工作流实体
			// 对于发布版本，先尝试从现有工作流获取元信息
			if wf, err := appworkflow.GetWorkflowDomainSVC().Get(ctx, &vo.GetPolicy{
				ID: workflowID,
				MetaOnly: true,
			}); err == nil && wf != nil {
				name = wf.Name
				description = wf.Desc
				iconURL = wf.IconURL
				flowMode = int32(wf.Mode)
			} else {
				// 回退方案：使用基本信息
				name = fmt.Sprintf("Workflow_%d", workflowID)
				description = versionInfo.VersionDescription
				flowMode = 1 // 默认为普通工作流模式
			}
			
			logs.CtxInfof(ctx, "Found published version: %s for workflow %d", version, workflowID)
		}
	} else { // SubmitOperate或空commit_id - 查询草稿
		logs.CtxInfof(ctx, "Querying draft version for commit_id: %s (type: %d)", req.CommitID, req.Type)
		
		// 获取指定commit的草稿，如果commit_id为空则获取当前草稿
		draft, err := repo.DraftV2(ctx, workflowID, req.CommitID)
		if err != nil {
			logs.CtxErrorf(ctx, "Failed to get draft for workflow %d, commit_id %s: %v", workflowID, req.CommitID, err)
			c.JSON(consts.StatusOK, &ynet_workflow.GetVersionSchemaResponse{
				Code: 404,
				Msg:  "Draft not found",
			})
			return
		}

		if draft != nil {
			schema = draft.Canvas
			version = req.CommitID // 对于草稿，使用commit_id作为版本标识
			if version == "" {
				version = "current-draft"
			}
			inputParams = draft.InputParamsStr
			outputParams = draft.OutputParamsStr
			
			if draft.DraftMeta != nil && !draft.DraftMeta.Timestamp.IsZero() {
				createdAt = draft.DraftMeta.Timestamp.UnixMilli()
			} else {
				createdAt = time.Now().UnixMilli()
			}
			
			// 获取工作流元信息 - 查询工作流实体
			if wf, err := appworkflow.GetWorkflowDomainSVC().Get(ctx, &vo.GetPolicy{
				ID: workflowID,
				MetaOnly: true,
			}); err == nil && wf != nil {
				name = wf.Name
				description = wf.Desc
				iconURL = wf.IconURL
				flowMode = int32(wf.Mode)
			} else {
				// 回退方案：使用基本信息
				name = fmt.Sprintf("Workflow_%d", workflowID)
				description = "Current draft"
				flowMode = 1 // 默认为普通工作流模式
			}
			
			logs.CtxInfof(ctx, "Found draft version with commit: %s for workflow %d", req.CommitID, workflowID)
		}
	}

	// 检查是否找到了数据
	if schema == "" {
		c.JSON(consts.StatusOK, &ynet_workflow.GetVersionSchemaResponse{
			Code: 404,
			Msg:  "Schema not found",
		})
		return
	}

	// 构建成功响应
	resp := &ynet_workflow.GetVersionSchemaResponse{
		Schema:       schema,
		Name:         name,
		Description:  stringPtr(description),
		IconURL:      stringPtr(iconURL),
		Version:      version,
		CommitID:     req.CommitID,
		CreatedAt:    createdAt,
		InputParams:  stringPtr(inputParams),
		OutputParams: stringPtr(outputParams),
		FlowMode:     flowMode,
		Code:         0,
		Msg:          "success",
	}

	logs.CtxInfof(ctx, "GetVersionSchema successful for workflow %d, returning schema length: %d", workflowID, len(schema))
	c.JSON(consts.StatusOK, resp)
}
