// Code generated by hertz generator.

package external_knowledge

import (
	"context"
	"strconv"

	"github.com/cloudwego/hertz/pkg/app"
	"github.com/cloudwego/hertz/pkg/protocol/consts"

	external_knowledge "github.com/coze-dev/coze-studio/backend/api/model/external_knowledge"
	"github.com/coze-dev/coze-studio/backend/application/base/ctxutil"
	externalKnowledgeApp "github.com/coze-dev/coze-studio/backend/application/external_knowledge"
	"github.com/coze-dev/coze-studio/backend/pkg/lang/ptr"
)

// CreateBinding .
// @router /api/external-knowledge/binding/create [POST]
func CreateBinding(ctx context.Context, c *app.RequestContext) {
	var err error
	var req external_knowledge.CreateBindingRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	// Get user ID from context
	userIDPtr := ctxutil.GetUIDFromCtx(ctx)
	if userIDPtr == nil {
		c.JSON(consts.StatusUnauthorized, external_knowledge.CreateBindingResponse{
			Code: 401,
			Msg:  "Unauthorized",
			Data: &external_knowledge.ExternalKnowledgeBinding{},
		})
		return
	}
	userID := strconv.FormatInt(ptr.From(userIDPtr), 10)

	resp, err := externalKnowledgeApp.ExternalKnowledgeApplicationSVC.CreateBinding(ctx, userID, &req)
	if err != nil {
		c.String(consts.StatusInternalServerError, err.Error())
		return
	}

	c.JSON(consts.StatusOK, resp)
}

// GetBindingList .
// @router /api/external-knowledge/binding/list [GET]
func GetBindingList(ctx context.Context, c *app.RequestContext) {
	var err error
	var req external_knowledge.GetBindingListRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	// Get user ID from context
	userIDPtr := ctxutil.GetUIDFromCtx(ctx)
	if userIDPtr == nil {
		c.JSON(consts.StatusUnauthorized, external_knowledge.GetBindingListResponse{
			Code:  401,
			Msg:   "Unauthorized",
			Data:  []*external_knowledge.ExternalKnowledgeBinding{},
			Total: 0,
		})
		return
	}
	userID := strconv.FormatInt(ptr.From(userIDPtr), 10)

	resp, err := externalKnowledgeApp.ExternalKnowledgeApplicationSVC.GetBindingList(ctx, userID, &req)
	if err != nil {
		c.String(consts.StatusInternalServerError, err.Error())
		return
	}

	c.JSON(consts.StatusOK, resp)
}

// UpdateBinding .
// @router /api/external-knowledge/binding/:id [PUT]
func UpdateBinding(ctx context.Context, c *app.RequestContext) {
	var err error
	var req external_knowledge.UpdateBindingRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	// Get user ID from context
	userIDPtr := ctxutil.GetUIDFromCtx(ctx)
	if userIDPtr == nil {
		c.JSON(consts.StatusUnauthorized, external_knowledge.UpdateBindingResponse{
			Code: 401,
			Msg:  "Unauthorized",
			Data: &external_knowledge.ExternalKnowledgeBinding{},
		})
		return
	}
	userID := strconv.FormatInt(ptr.From(userIDPtr), 10)

	resp, err := externalKnowledgeApp.ExternalKnowledgeApplicationSVC.UpdateBinding(ctx, userID, &req)
	if err != nil {
		c.String(consts.StatusInternalServerError, err.Error())
		return
	}

	c.JSON(consts.StatusOK, resp)
}

// DeleteBinding .
// @router /api/external-knowledge/binding/:id [DELETE]
func DeleteBinding(ctx context.Context, c *app.RequestContext) {
	var err error
	var req external_knowledge.DeleteBindingRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	// Get user ID from context
	userIDPtr := ctxutil.GetUIDFromCtx(ctx)
	if userIDPtr == nil {
		c.JSON(consts.StatusUnauthorized, external_knowledge.DeleteBindingResponse{
			Code: 401,
			Msg:  "Unauthorized",
		})
		return
	}
	userID := strconv.FormatInt(ptr.From(userIDPtr), 10)

	resp, err := externalKnowledgeApp.ExternalKnowledgeApplicationSVC.DeleteBinding(ctx, userID, &req)
	if err != nil {
		c.String(consts.StatusInternalServerError, err.Error())
		return
	}

	c.JSON(consts.StatusOK, resp)
}

// ValidateBindingKey .
// @router /api/external-knowledge/binding/validate [POST]
func ValidateBindingKey(ctx context.Context, c *app.RequestContext) {
	var err error
	var req external_knowledge.ValidateBindingKeyRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	// Check if user is authenticated (optional for validation)
	userIDPtr := ctxutil.GetUIDFromCtx(ctx)
	if userIDPtr == nil {
		c.JSON(consts.StatusUnauthorized, external_knowledge.ValidateBindingKeyResponse{
			Code:    401,
			Msg:     "Unauthorized",
			IsValid: false,
		})
		return
	}

	resp, err := externalKnowledgeApp.ExternalKnowledgeApplicationSVC.ValidateBindingKey(ctx, &req)
	if err != nil {
		c.String(consts.StatusInternalServerError, err.Error())
		return
	}

	c.JSON(consts.StatusOK, resp)
}

// GetRAGFlowDatasets .
// @router /api/external-knowledge/ragflow/datasets [GET]
func GetRAGFlowDatasets(ctx context.Context, c *app.RequestContext) {
	var err error
	var req external_knowledge.GetRAGFlowDatasetsRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	// Get user ID from context
	userIDPtr := ctxutil.GetUIDFromCtx(ctx)
	if userIDPtr == nil {
		c.JSON(consts.StatusOK, &external_knowledge.GetRAGFlowDatasetsResponse{
			Code: 401,
			Msg:  "Unauthorized",
			Data: []*external_knowledge.RAGFlowDataset{},
		})
		return
	}
	userID := strconv.FormatInt(ptr.From(userIDPtr), 10)

	// Call application service to get RAGFlow datasets
	resp, err := externalKnowledgeApp.ExternalKnowledgeApplicationSVC.GetRAGFlowDatasets(ctx, userID, &req)
	if err != nil {
		c.JSON(consts.StatusOK, &external_knowledge.GetRAGFlowDatasetsResponse{
			Code: 500,
			Msg:  err.Error(),
			Data: []*external_knowledge.RAGFlowDataset{},
		})
		return
	}

	c.JSON(consts.StatusOK, resp)
}

// Retrieval .
// @router /api/external-knowledge/retrieval [POST]
func Retrieval(ctx context.Context, c *app.RequestContext) {
	var err error
	var req external_knowledge.RetrievalRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.String(consts.StatusBadRequest, err.Error())
		return
	}

	// Get user ID from context (optional for retrieval)
	userIDPtr := ctxutil.GetUIDFromCtx(ctx)
	if userIDPtr == nil {
		c.JSON(consts.StatusUnauthorized, external_knowledge.RetrievalResponse{
			Code: 401,
			Msg:  "Unauthorized",
		})
		return
	}
	userID := strconv.FormatInt(ptr.From(userIDPtr), 10)

	// Call application service to perform retrieval
	resp, err := externalKnowledgeApp.ExternalKnowledgeApplicationSVC.Retrieval(ctx, userID, &req)
	if err != nil {
		c.JSON(consts.StatusOK, &external_knowledge.RetrievalResponse{
			Code: 500,
			Msg:  err.Error(),
		})
		return
	}

	c.JSON(consts.StatusOK, resp)
}
